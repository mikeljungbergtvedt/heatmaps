<!DOCTYPE html>
<html lang="nb-NO">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forslag til Gire Soner</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Roboto', sans-serif; margin: 0; padding: 0; background: #f4f4f4; color: #333; font-size: 16px; }
        header { background: #003087; color: #fff; padding: 15px; text-align: center; }
        header img.logo { max-width: 120px; height: auto; }
        h1 { margin: 5px 0; font-size: 1.5em; font-weight: 400; color: #e0e0e0; text-transform: uppercase; letter-spacing: 1px; }
        .nav-bar { max-width: 1200px; margin: 10px auto; text-align: center; }
        .nav-bar a { display: inline-block; color: #fff; text-decoration: none; padding: 10px 20px; margin: 5px; border-radius: 5px; font-weight: 700; transition: background-color 0.3s, transform 0.2s; }
        .nav-bar a:hover { transform: scale(1.05); }
        .nav-bar a.active { filter: brightness(1.2); }
        .nav-bar a.all { background: #666; }
        .nav-bar a.skedsmo { background: #1d4877; }
        .nav-bar a.bergen { background: #1b8a5a; }
        .nav-bar a.stavanger { background: #fbb021; }
        .nav-bar a.trondheim { background: #f68838; }
        .nav-bar a.ski { background: #ee3e32; }
        .map-container { max-width: 1200px; margin: 20px auto; padding: 20px; background: rgba(255, 255, 255, 0.8); border-radius: 8px; height: 80vh; position: relative; }
        #map { width: 100%; height: 100%; }
        .custom-marker { position: relative; }
        .custom-marker div { width: 40px; height: 40px; line-height: 40px; border-radius: 50%; font-size: 14px; font-weight: bold; color: #fff; text-align: center; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.3); background: inherit; }
        .error-message { text-align: center; color: red; padding: 10px; display: none; }
        .leaflet-popup-content ul { list-style-type: none; padding: 0; margin: 0; }
        .map-attribution { position: absolute; bottom: 10px; left: 20px; font-size: 10px; color: #333; background: rgba(255, 255, 255, 0.7); padding: 2px 5px; border-radius: 3px; z-index: 1000; }
        .search-container {
            position: absolute; bottom: 50px; left: 50px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); padding: 4px 8px; border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); backdrop-filter: blur(5px);
            display: flex; align-items: center;
        }
        .search-container input {
            padding: 5px; font-size: 14px; border: none; background: transparent;
            width: 180px; outline: none; color: #333; transition: color 0.3s;
        }
        .search-container input:focus { color: #003087; }
        @media (max-width: 600px) {
            .nav-bar a { display: block; margin: 5px auto; width: 80%; }
            h1 { font-size: 1.3em; }
            .map-container { margin: 10px; padding: 10px; height: 70vh; }
            .custom-marker div { width: 38px; height: 38px; line-height: 38px; font-size: 12px; }
            .map-attribution { font-size: 8px; }
            .search-container { bottom: 40px; left: 30px; padding: 3px 6px; }
            .search-container input { font-size: 12px; width: 140px; }
        }
    </style>
</head>
<body>
    <header><img src="logo.png" alt="Autoringen Logo" class="logo"><h1>Forslag til Gire Soner</h1></header>
    <div class="nav-bar">
        <a href="javascript:void(0)" onclick="toggleLayer('all')" class="all active">Alle</a>
        <a href="javascript:void(0)" onclick="toggleLayer('Skedsmo')" class="skedsmo">Skedsmo</a>
        <a href="javascript:void(0)" onclick="toggleLayer('Bergen')" class="bergen">Bergen</a>
        <a href="javascript:void(0)" onclick="toggleLayer('Stavanger')" class="stavanger">Stavanger</a>
        <a href="javascript:void(0)" onclick="toggleLayer('Trondheim')" class="trondheim">Trondheim</a>
        <a href="javascript:void(0)" onclick="toggleLayer('Ski')" class="ski">Ski</a>
    </div>
    <div class="map-container">
        <div id="map"></div>
        <div class="map-attribution">Powered by OpenStreetMap | Autoringen | Postnummerdata frå <a href="http://www.erikbolstad.no/postnummer/" target="_blank">Erik Bolstad</a></div>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Søk poststed" onkeyup="searchSubRegion()">
        </div>
    </div>
    <div class="error-message" id="errorMessage"></div>
    <footer></footer>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script>
        const map = L.map('map', { minZoom: 5, maxZoom: 18 });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>' }).addTo(map);
        const layers = {
            'all': L.layerGroup(),
            'Skedsmo': L.layerGroup(),
            'Bergen': L.layerGroup(),
            'Stavanger': L.layerGroup(),
            'Trondheim': L.layerGroup(),
            'Ski': L.layerGroup()
        };
        const regionColors = { 'Bergen': '#1b8a5a', 'Trondheim': '#f68838', 'Stavanger': '#fbb021', 'Skedsmo': '#1d4877', 'Ski': '#ee3e32' };
        let allMarkers = [];
        function toggleLayer(sted) {
            Object.keys(layers).forEach(key => { layers[key].clearLayers(); document.querySelectorAll('.nav-bar a').forEach(a => a.classList.remove('active')); });
            document.querySelector(`.nav-bar a[onclick="toggleLayer('${sted}')"]`).classList.add('active');
            Papa.parse('./reconciled_boundary_postcodes.csv', {
                download: true, header: true, complete: function(results) {
                    const data = results.data.filter(row => row.Latitude && row.Longitude && !isNaN(parseFloat(row.Latitude)) && !isNaN(parseFloat(row.Longitude)) && (sted === 'all' || row.Region === sted));
                    allMarkers = [];
                    const regions = sted === 'all' ? ['Bergen', 'Trondheim', 'Stavanger', 'Skedsmo', 'Ski'] : [sted];
                    regions.forEach(region => {
                        const regionData = data.filter(row => row.Region === region && parseFloat(row.Latitude) !== 0 && parseFloat(row.Longitude) !== 0);
                        if (regionData.length > 0) {
                            const points = regionData.map(row => ({
                                type: 'Feature',
                                geometry: { type: 'Point', coordinates: [parseFloat(row.Longitude), parseFloat(row.Latitude)] },
                                properties: { Region: row.Region, SubRegion: row.SubRegion, Postcode: row.RangeStart, AutoringenPrice: row['Autoringen Price'], SuggestedPrice: row['Suggested Autoringen Price'], Distance: row.Distance_km }
                            }));
                            const featureCollection = { type: 'FeatureCollection', features: points };
                            const hull = turf.convex(featureCollection);
                            if (hull) {
                                L.geoJSON(hull, {
                                    style: {
                                        fillColor: regionColors[region],
                                        weight: 2,
                                        opacity: 1,
                                        color: 'white',
                                        fillOpacity: 0.5
                                    },
                                    onEachFeature: (feature, layer) => {
                                        const postcodes = regionData.map(row => row.RangeStart).join(', ');
                                        layer.bindPopup(`<b>${region} Delivery Zone</b><br>Postcodes: ${postcodes}<br>Autoringen Price: ${regionData[0]['Autoringen Price']}<br>Suggested Price: ${regionData[0]['Suggested Autoringen Price']}`);
                                    }
                                }).addTo(layers[sted]);
                            }
                        }
                        const missingData = data.filter(row => row.Region === region && row.RangeStart.startsWith('[MISSING]'));
                        missingData.forEach(row => {
                            const marker = L.marker([0, 0], {
                                icon: L.divIcon({
                                    className: 'custom-marker',
                                    html: `<div style="background-color: #FF00FF;"></div>`,
                                    iconSize: [40, 40],
                                    iconAnchor: [20, 40]
                                })
                            }).bindPopup(`<ul><li>Region: ${row.Region}<br>SubRegion: ${row.SubRegion}<br>Postcode: ${row.RangeStart}<br>Gire Price: ${row['Gire Price'] || 'N/A'}<br>Autoringen Price: ${row['Autoringen Price'] || 'N/A'}<br>Suggested Price: ${row['Suggested Autoringen Price'] || 'N/A'}<br>Distance: ${row.Distance_km} km</li></ul>`);
                            layers[sted].addLayer(marker);
                            allMarkers.push({ lat: 0, lng: 0, subRegion: row.SubRegion || 'N/A' });
                        });
                    });
                    map.eachLayer(layer => { if (layer instanceof L.LayerGroup) map.removeLayer(layer); });
                    map.addLayer(layers[sted]);
                    if (data.length > 0) {
                        const bounds = L.latLngBounds([]);
                        data.forEach(row => {
                            if (parseFloat(row.Latitude) !== 0 && parseFloat(row.Longitude) !== 0) {
                                bounds.extend([parseFloat(row.Latitude), parseFloat(row.Longitude)]);
                            }
                        });
                        if (bounds.isValid()) map.fitBounds(bounds, { padding: [50, 50], maxZoom: 15 });
                        else map.setView([64.0, 10.0], 5);
                    } else map.setView([64.0, 10.0], 5);
                    map.invalidateSize();
                }, error: function(error) {
                    console.error('Error loading CSV:', error);
                    document.getElementById('errorMessage').textContent = 'Error loading reconciled_boundary_postcodes.csv. Check file path.';
                    document.getElementById('errorMessage').style.display = 'block';
                    map.setView([64.0, 10.0], 5);
                }
            });
        }
        function searchSubRegion() {
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            map.eachLayer(layer => {
                if (layer instanceof L.LayerGroup) {
                    layer.eachLayer(marker => {
                        const markerData = allMarkers.find(m => m.lat === marker.getLatLng().lat && m.lng === marker.getLatLng().lng);
                        if (markerData && markerData.subRegion.toLowerCase().includes(searchValue)) {
                            marker.openPopup();
                            map.setView(marker.getLatLng(), 15);
                        }
                    });
                }
            });
        }
        toggleLayer('all');
    </script>
</body>
</html>
