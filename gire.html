<!DOCTYPE html>
<html lang="nb-NO">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Zones Map</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Roboto', sans-serif; margin: 0; padding: 0; background: #f4f4f4; color: #333; }
        header { background: #003087; color: #fff; padding: 20px; text-align: center; }
        header img.logo { max-width: 150px; height: auto; }
        h1 { margin: 10px 0; font-size: 2.5em; font-weight: 700; }
        .nav-bar { max-width: 1200px; margin: 10px auto; text-align: center; }
        .nav-bar a { display: inline-block; color: #fff; text-decoration: none; padding: 10px 20px; margin: 5px; border-radius: 5px; font-weight: 700; transition: background-color 0.3s, transform 0.2s; }
        .nav-bar a:hover { transform: scale(1.05); }
        .nav-bar a.active { filter: brightness(1.2); }
        .nav-bar a.all { background: #666; }
        .nav-bar a.skedsmo { background: #1d4877; }
        .nav-bar a.bergen { background: #1b8a5a; }
        .nav-bar a.stavanger { background: #fbb021; }
        .nav-bar a.trondheim { background: #f68838; }
        .nav-bar a.ski { background: #ee3e32; }
        .map-container { max-width: 1200px; margin: 20px auto; padding: 20px; background: rgba(255, 255, 255, 0.8); border-radius: 8px; height: 80vh; }
        #map { width: 100%; height: 100%; }
        .custom-marker { position: relative; }
        .custom-marker div { width: 30px; height: 30px; line-height: 30px; border-radius: 50%; font-size: 14px; font-weight: bold; color: #fff; text-align: center; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.3); background: inherit; }
        .error-message { text-align: center; color: red; padding: 10px; display: none; }
        .leaflet-popup-content ul { list-style-type: none; padding: 0; margin: 0; }
        @media (max-width: 600px) { .nav-bar a { display: block; margin: 5px auto; width: 80%; } h1 { font-size: 1.8em; } .map-container { margin: 10px; padding: 10px; height: 70vh; } .custom-marker div { width: 28px; height: 28px; line-height: 28px; font-size: 12px; } }
    </style>
</head>
<body>
    <header><img src="logo.png" alt="Autoringen Logo" class="logo"><h1>Delivery Zones Map</h1></header>
    <div class="nav-bar">
        <a href="javascript:void(0)" onclick="toggleLayer('all')" class="all active">Alle</a>
        <a href="javascript:void(0)" onclick="toggleLayer('Skedsmo')" class="skedsmo">Skedsmo</a>
        <a href="javascript:void(0)" onclick="toggleLayer('Bergen')" class="bergen">Bergen</a>
        <a href="javascript:void(0)" onclick="toggleLayer('Stavanger')" class="stavanger">Stavanger</a>
        <a href="javascript:void(0)" onclick="toggleLayer('Trondheim')" class="trondheim">Trondheim</a>
        <a href="javascript:void(0)" onclick="toggleLayer('Ski')" class="ski">Ski</a>
    </div>
    <div class="map-container"><div id="map"></div></div>
    <div class="error-message" id="errorMessage"></div>
    <footer><p>Powered by <a href="https://www.openstreetmap.org" target="_blank">OpenStreetMap</a> | <a href="https://www.autoringen.no" target="_blank">Autoringen</a> | Postnummerdata frå <a href="http://www.erikbolstad.no/postnummer/" target="_blank">Erik Bolstad</a></p></footer>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script>
        const map = L.map('map', { minZoom: 5, maxZoom: 18 });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>' }).addTo(map);
        const layers = { 'all': L.layerGroup(), 'Skedsmo': L.layerGroup(), 'Bergen': L.layerGroup(), 'Stavanger': L.layerGroup(), 'Trondheim': L.layerGroup(), 'Ski': L.layerGroup() };
        const regionColors = { 'Bergen': '#1b8a5a', 'Trondheim': '#f68838', 'Stavanger': '#fbb021', 'Skedsmo': '#1d4877', 'Ski': '#ee3e32' };
        const minPrice = 580; const maxPrice = 1090;
        function getHeatmapColor(price) { const ratio = (price - minPrice) / (maxPrice - minPrice); return `hsl(${(1 - ratio) * 240}, 70%, 50%)`; }
        function toggleLayer(sted) {
            Object.keys(layers).forEach(key => { layers[key].clearLayers(); document.querySelectorAll('.nav-bar a').forEach(a => a.classList.remove('active')); });
            document.querySelector(`.nav-bar a[onclick="toggleLayer('${sted}')"]`).classList.add('active');
            Papa.parse('./merged_postcodes_complete.csv', {
                download: true, header: true, complete: function(results) {
                    const data = results.data.filter(row => row.latitude && row.longitude && !isNaN(parseFloat(row.latitude)) && !isNaN(parseFloat(row.longitude)) && (sted === 'all' || row.Region === sted));
                    if (sted === 'all') {
                        const uniqueCoords = new Set(); data.forEach(row => uniqueCoords.add(`${parseFloat(row.latitude).toFixed(6)},${parseFloat(row.longitude).toFixed(6)}`));
                        uniqueCoords.forEach(coordKey => {
                            const [lat, lng] = coordKey.split(',').map(parseFloat);
                            const matchingRows = data.filter(row => `${parseFloat(row.latitude).toFixed(6)},${parseFloat(row.longitude).toFixed(6)}` === coordKey);
                            const primaryRegion = matchingRows[0].Region; const isMissing = !matchingRows[0]['Sub Region'] || matchingRows[0]['Sub Region'] === '';
                            let markerColor = regionColors[primaryRegion] || '#000000'; if (isMissing) markerColor = '#FF00FF';
                            const displayValue = matchingRows.length > 1 ? matchingRows.length : '';
                            let popupContent = matchingRows.length > 1 ? '<ul>' : '<ul>';
                            matchingRows.forEach(row => { popupContent += `<li>${row.Region}<br>Poststed: ${row['Sub Region'] || 'N/A'}<br>Postkode: ${row.Postnummer}<br>Autoringen Price: ${row['Priser Autoringen'] || 'N/A'}<br>Foreslått Autoringen Pris: ${row['Foreslått Autoringen Pris'] || 'N/A'}<br>Latitude: ${lat}<br>Longitude: ${lng}<br></li>`; });
                            popupContent += '</ul>';
                            layers['all'].addLayer(L.marker([lat, lng], { title: `${matchingRows.length} zone${matchingRows.length > 1 ? 's' : ''}`, icon: L.divIcon({ className: 'custom-marker', html: `<div style="background-color: ${markerColor};">${displayValue}</div>`, iconSize: [30, 30], iconAnchor: [15, 30] }) }).bindPopup(popupContent));
                        });
                    } else {
                        data.forEach(row => {
                            const lat = parseFloat(row.latitude); const lng = parseFloat(row.longitude);
                            const priceStr = row['Foreslått Autoringen Pris'] || '0';
                            const price = parseInt(priceStr.split(',')[0]) || 0; // Take integer before comma
                            let markerColor = getHeatmapColor(price); if (!row['Sub Region'] || row['Sub Region'] === '') markerColor = '#FF00FF';
                            const displayValue = price < 1000 ? price.toString().padStart(3, '0') : price.toString().padStart(4, '0');
                            let popupContent = '<ul>';
                            popupContent += `<li>${row.Region}<br>Poststed: ${row['Sub Region'] || 'N/A'}<br>Postkode: ${row.Postnummer}<br>Autoringen Price: ${row['Priser Autoringen'] || 'N/A'}<br>Foreslått Autoringen Pris: ${row['Foreslått Autoringen Pris'] || 'N/A'}<br>Latitude: ${lat}<br>Longitude: ${lng}<br></li>`;
                            popupContent += '</ul>';
                            layers[sted].addLayer(L.marker([lat, lng], { title: `Price: ${displayValue} NOK`, icon: L.divIcon({ className: 'custom-marker', html: `<div style="background-color: ${markerColor};">${displayValue}</div>`, iconSize: [30, 30], iconAnchor: [15, 30] }) }).bindPopup(popupContent));
                        });
                    }
                    map.eachLayer(layer => { if (layer instanceof L.LayerGroup) map.removeLayer(layer); });
                    layers[sted].addTo(map);
                    if (data.length > 0) { const bounds = L.latLngBounds([]); data.forEach(row => bounds.extend([parseFloat(row.latitude), parseFloat(row.longitude)])); if (bounds.isValid()) map.fitBounds(bounds, { padding: [50, 50], maxZoom: 15 }); else map.setView([64.0, 10.0], 5); } else map.setView([64.0, 10.0], 5);
                    map.invalidateSize();
                }, error: function(error) { console.error('Error loading CSV:', error); document.getElementById('errorMessage').textContent = 'Error loading merged_postcodes_complete.csv. Check file path.'; document.getElementById('errorMessage').style.display = 'block'; map.setView([64.0, 10.0], 5); }
            });
        }
        toggleLayer('all');
    </script>
</body>
</html>
